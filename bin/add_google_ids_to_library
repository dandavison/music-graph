#!/usr/bin/env python
import json

from fuzzywuzzy.process import extractOne
from sqlalchemy import select
from sqlalchemy import update

from music_graph.db.sqla import fetchall
from music_graph.db.sqla import get_table
from music_graph.utils import info
from music_graph.utils import warn


FUZZYWUZZY_SCORE_CUTOFF = 95

artists_t = get_table('artists')
google_tracks_t = get_table('google_tracks')

mbid2name = dict(fetchall(select([artists_t.c.id, artists_t.c.name])))

google_artists = filter(
    all,
    ((artist_id, json.loads(track_json).get('albumArtist'))
     for artist_id, track_json in fetchall(select([google_tracks_t.c.artist_id,
                                                   google_tracks_t.c.json]))))

for google_artist_id, google_artist_name in google_artists:
    lib_artist_name, score, mbid = extractOne(google_artist_name, mbid2name)

    output = (score,
              google_artist_name.encode('utf-8'),
              lib_artist_name.encode('utf-8'))

    if score > FUZZYWUZZY_SCORE_CUTOFF:
        (update(artists_t)
         .values(google_id=google_artist_id)
         .where(artists_t.c.id == mbid)
         .execute())
        info("Updated google ID for artist '%s'" % lib_artist_name)
    else:
        warn("Low fuzzy match score: %d\n\t%s\n\t%s" % output)
