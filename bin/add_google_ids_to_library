#!/usr/bin/env python
import json

from fuzzywuzzy.process import extractOne

from music_graph.db import Table
from music_graph.settings import DATABASE_URI
from music_graph.utils import warn


FUZZYWUZZY_SCORE_CUTOFF = 95

artist_table = Table('artist', DATABASE_URI)
google_track_table = Table('google_track', DATABASE_URI)

mbid2name = dict((artist.id, artist.name)
                 for artist in artist_table.select())

google_artists = filter(
    all,
    ((track.artist_id, json.loads(track.json).get('albumArtist'))
     for track in google_track_table.select()))

for google_artist_id, google_artist_name in google_artists:
    lib_artist_name, score, mbid = extractOne(google_artist_name, mbid2name)

    output = (score,
              google_artist_name.encode('utf-8'),
              lib_artist_name.encode('utf-8'))

    if score > FUZZYWUZZY_SCORE_CUTOFF:
        artist_table.update({'google_id': google_artist_id}, {'id': mbid})
    else:
        warn("Low fuzzy match score: %d\n\t%s\n\t%s" % output)
