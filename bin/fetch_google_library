#!/usr/bin/env python
import json

from sqlalchemy.sql import select

from music_graph.apis.google import fetch_all_tracks
from music_graph.db.sqla import ENGINE
from music_graph.db.sqla import get_table


google_tracks = get_table('google_tracks')
conn = ENGINE.connect()
tracks = fetch_all_tracks()

values = []
for track in tracks:
    try:
        [artist_id] = track['artistId']
    except (KeyError, ValueError):
        continue
    values.append({
        'artist_id': artist_id,
        'json': json.dumps(track)
    })

conn.execute(google_tracks.insert(), values)
